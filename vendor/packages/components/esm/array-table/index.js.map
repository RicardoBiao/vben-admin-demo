{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["array-table/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Ref } from 'vue'\r\nimport { defineComponent, ref, computed, h } from 'vue'\r\nimport type { GeneralField, FieldDisplayTypes, ArrayField } from '@formily/core'\r\nimport {\r\n  useField,\r\n  useFieldSchema,\r\n  FragmentComponent,\r\n  RecursionField,\r\n} from '@formily/vue'\r\nimport { observer } from '@formily/reactive-vue'\r\nimport { isArr, isBool } from '@formily/shared'\r\nimport { ArrayBase } from '../array-base'\r\nimport { stylePrefix } from '../__builtins__/configs'\r\nimport { composeExport } from '../__builtins__/shared'\r\nimport type { Schema } from '@formily/json-schema'\r\nimport type { VNode } from 'vue'\r\nimport { Table, Pagination, Select, Badge } from 'ant-design-vue'\r\nimport { Space } from '../space'\r\nimport type { TableProps } from 'ant-design-vue/lib/table'\r\nimport type { ColumnProps } from 'ant-design-vue/lib/table/column'\r\nimport type { PaginationProps } from 'ant-design-vue/lib/pagination'\r\nimport type { SelectProps } from 'ant-design-vue/lib/select'\r\n\r\ninterface ObservableColumnSource {\r\n  field: GeneralField\r\n  columnProps: ColumnProps\r\n  schema: Schema\r\n  display: FieldDisplayTypes\r\n  name: string\r\n}\r\n\r\ninterface IArrayTablePaginationProps extends PaginationProps {\r\n  dataSource?: any[]\r\n}\r\n\r\ninterface IStatusSelectProps extends SelectProps {\r\n  pageSize?: number\r\n  onChange?: (value: any, option: any | any[]) => void\r\n}\r\n\r\nconst isColumnComponent = (schema: Schema) => {\r\n  return schema['x-component']?.indexOf('Column') > -1\r\n}\r\n\r\nconst isOperationsComponent = (schema: Schema) => {\r\n  return schema['x-component']?.indexOf('Operations') > -1\r\n}\r\n\r\nconst isAdditionComponent = (schema: Schema) => {\r\n  return schema['x-component']?.indexOf('Addition') > -1\r\n}\r\n\r\nconst useArrayTableSources = (\r\n  arrayFieldRef: Ref<ArrayField>,\r\n  schemaRef: Ref<Schema>\r\n) => {\r\n  const arrayField = arrayFieldRef.value\r\n  const parseSources = (schema: Schema): ObservableColumnSource[] => {\r\n    if (\r\n      isColumnComponent(schema) ||\r\n      isOperationsComponent(schema) ||\r\n      isAdditionComponent(schema)\r\n    ) {\r\n      if (!schema['x-component-props']?.['dataIndex'] && !schema['name'])\r\n        return []\r\n      const name = schema['x-component-props']?.['dataIndex'] || schema['name']\r\n      const field = arrayField.query(arrayField.address.concat(name)).take()\r\n      const columnProps =\r\n        field?.component?.[1] || schema['x-component-props'] || {}\r\n      const display = field?.display || schema['x-display']\r\n      return [\r\n        {\r\n          name,\r\n          display,\r\n          field,\r\n          schema,\r\n          columnProps,\r\n        },\r\n      ]\r\n    } else if (schema.properties) {\r\n      return schema.reduceProperties((buf, schema) => {\r\n        return buf.concat(parseSources(schema))\r\n      }, [])\r\n    }\r\n  }\r\n\r\n  const parseArrayItems = (schema: Schema['items']) => {\r\n    if (!schema) return []\r\n    const sources: ObservableColumnSource[] = []\r\n    const items = isArr(schema) ? schema : [schema]\r\n    return items.reduce((columns, schema) => {\r\n      const item = parseSources(schema)\r\n      if (item) {\r\n        return columns.concat(item)\r\n      }\r\n      return columns\r\n    }, sources)\r\n  }\r\n\r\n  if (!schemaRef.value) throw new Error('can not found schema object')\r\n\r\n  return parseArrayItems(schemaRef.value.items)\r\n}\r\n\r\nconst useArrayTableColumns = (\r\n  sources: ObservableColumnSource[]\r\n): ColumnProps[] => {\r\n  return sources.reduce((buf, { name, columnProps, schema, display }, key) => {\r\n    if (display !== 'visible') return buf\r\n    if (!isColumnComponent(schema)) return buf\r\n    return buf.concat({\r\n      ...columnProps,\r\n      key,\r\n      dataIndex: name,\r\n      customRender: ({ record, index }) => {\r\n        const children = h(\r\n          ArrayBase.Item,\r\n          {\r\n            key: `${key}${index}`,\r\n            index,\r\n            record,\r\n          },\r\n          () =>\r\n            h(RecursionField, {\r\n              schema,\r\n              name: index,\r\n              onlyRenderProperties: true,\r\n            })\r\n        )\r\n        return children\r\n      },\r\n    })\r\n  }, [])\r\n}\r\n\r\nconst useAddition = () => {\r\n  const schema = useFieldSchema()\r\n  return schema.value.reduceProperties((addition, schema, key) => {\r\n    if (isAdditionComponent(schema)) {\r\n      return h(RecursionField, {\r\n        schema,\r\n        name: key,\r\n      })\r\n    }\r\n    return addition\r\n  }, null)\r\n}\r\n\r\nconst schedulerRequest = {\r\n  request: null,\r\n}\r\n\r\nconst StatusSelect = observer(\r\n  defineComponent({\r\n    props: ['value', 'options', 'pageSize', 'onChange'],\r\n    setup(props: IStatusSelectProps) {\r\n      const fieldRef = useField<ArrayField>()\r\n      const prefixCls = `${stylePrefix}-array-table`\r\n\r\n      return () => {\r\n        const field = fieldRef.value\r\n        const width = String(props.options?.length).length * 15\r\n        const errors = field.errors\r\n        const parseIndex = (address: string) => {\r\n          return Number(\r\n            address\r\n              .slice(address.indexOf(field.address.toString()) + 1)\r\n              .match(/(\\d+)/)?.[1]\r\n          )\r\n        }\r\n        return h(\r\n          Select,\r\n          {\r\n            style: {\r\n              width: `${width < 60 ? 60 : width}px`,\r\n            },\r\n            class: [\r\n              `${prefixCls}-status-select`,\r\n              {\r\n                'has-error': errors?.length,\r\n              },\r\n            ],\r\n            value: props.value,\r\n            virtual: true,\r\n            onChange: props.onChange,\r\n          },\r\n          {\r\n            default: () => {\r\n              return props.options?.map(({ label, value }) => {\r\n                const hasError = errors.some(({ address }) => {\r\n                  const currentIndex = parseIndex(address)\r\n                  const startIndex = ((value as number) - 1) * props.pageSize\r\n                  const endIndex = (value as number) * props.pageSize\r\n                  return currentIndex >= startIndex && currentIndex <= endIndex\r\n                })\r\n                return h(\r\n                  Select.Option,\r\n                  {\r\n                    key: value,\r\n                    label,\r\n                    value,\r\n                  },\r\n                  {\r\n                    default: () => {\r\n                      if (hasError) {\r\n                        return h(Badge, { dot: true }, () => label)\r\n                      }\r\n                      return label\r\n                    },\r\n                  }\r\n                )\r\n              })\r\n            },\r\n          }\r\n        )\r\n      }\r\n    },\r\n  }),\r\n  {\r\n    scheduler: (update) => {\r\n      clearTimeout(schedulerRequest.request)\r\n      schedulerRequest.request = setTimeout(() => {\r\n        update()\r\n      }, 100)\r\n    },\r\n  }\r\n)\r\n\r\nconst ArrayTablePagination = defineComponent<IArrayTablePaginationProps>({\r\n  inheritAttrs: false,\r\n  setup(_props, { attrs, slots }) {\r\n    const prefixCls = `${stylePrefix}-array-table`\r\n    const current = ref(1)\r\n    return () => {\r\n      const props = attrs as unknown as IArrayTablePaginationProps\r\n      const pageSize = computed(() => props.pageSize || 10)\r\n      const dataSource = computed(() => props.dataSource || [])\r\n      const startIndex = computed(() => (current.value - 1) * pageSize.value)\r\n      const size = computed(() => props.size || 'default')\r\n      const endIndex = computed(() => startIndex.value + pageSize.value - 1)\r\n      const total = computed(() => dataSource.value?.length || 0)\r\n      const totalPage = computed(() => Math.ceil(total.value / pageSize.value))\r\n      const pages = computed(() =>\r\n        Array.from(new Array(totalPage.value)).map((_, index) => {\r\n          const page = index + 1\r\n          return {\r\n            label: page,\r\n            value: page,\r\n          }\r\n        })\r\n      )\r\n\r\n      const handleChange = (val: number) => {\r\n        current.value = val\r\n      }\r\n\r\n      const renderPagination = () => {\r\n        if (totalPage.value <= 1) return\r\n        return h(\r\n          'div',\r\n          {\r\n            class: [`${prefixCls}-pagination`],\r\n          },\r\n          h(Space, {}, () => [\r\n            h(StatusSelect, {\r\n              value: current.value,\r\n              onChange: handleChange,\r\n              pageSize: pageSize.value,\r\n              options: pages.value,\r\n              notFoundContent: false,\r\n            }),\r\n            h(Pagination, {\r\n              ...props,\r\n              pageSize: pageSize.value,\r\n              current: current.value,\r\n              size: size.value,\r\n              total: total.value,\r\n              showSizeChanger: false,\r\n              onChange: handleChange,\r\n            }),\r\n          ])\r\n        )\r\n      }\r\n      return h(FragmentComponent, {}, () =>\r\n        slots?.default?.(\r\n          dataSource.value?.slice(startIndex.value, endIndex.value + 1),\r\n          renderPagination\r\n        )\r\n      )\r\n    }\r\n  },\r\n})\r\n\r\nconst ArrayTableInner = observer(\r\n  defineComponent<TableProps>({\r\n    name: 'ArrayTable',\r\n    inheritAttrs: false,\r\n    setup(_props, { attrs, slots }) {\r\n      const fieldRef = useField<ArrayField>()\r\n      const schemaRef = useFieldSchema()\r\n      const prefixCls = `${stylePrefix}-array-table`\r\n      const { getKey, keyMap } = ArrayBase.useKey(schemaRef.value)\r\n\r\n      const defaultRowKey = (record: any) => {\r\n        return getKey(record)\r\n      }\r\n\r\n      return () => {\r\n        const props = attrs as unknown as TableProps\r\n        const field = fieldRef.value\r\n        const dataSource = Array.isArray(field.value) ? field.value.slice() : []\r\n        const sources = useArrayTableSources(fieldRef, schemaRef)\r\n        const columns = useArrayTableColumns(sources)\r\n        const pagination = isBool(props.pagination) ? {} : props.pagination\r\n\r\n        const renderStateManager = () =>\r\n          sources.map((column, key) => {\r\n            //专门用来承接对Column的状态管理\r\n            if (!isColumnComponent(column.schema)) return\r\n            return h(RecursionField, {\r\n              name: column.name,\r\n              schema: column.schema,\r\n              onlyRenderSelf: true,\r\n              key,\r\n            })\r\n          })\r\n\r\n        const renderTable = (dataSource?: any[], pager?: () => VNode) => {\r\n          return h(\r\n            'div',\r\n            {\r\n              class: prefixCls,\r\n            },\r\n            h(\r\n              ArrayBase,\r\n              {\r\n                keyMap,\r\n              },\r\n              () => [\r\n                h(\r\n                  Table,\r\n                  {\r\n                    ...attrs,\r\n                    size: 'small',\r\n                    bordered: true,\r\n                    rowKey: defaultRowKey,\r\n                    pagination: false,\r\n                    columns,\r\n                    dataSource,\r\n                  },\r\n                  slots\r\n                ),\r\n                h(\r\n                  'div',\r\n                  {\r\n                    style: {\r\n                      marginTop: '5px',\r\n                      marginBottom: '5px',\r\n                    },\r\n                  },\r\n                  pager?.()\r\n                ),\r\n                renderStateManager(),\r\n                useAddition(),\r\n              ]\r\n            )\r\n          )\r\n        }\r\n\r\n        if (!pagination) {\r\n          return renderTable(dataSource, null)\r\n        }\r\n\r\n        return h(\r\n          ArrayTablePagination,\r\n          {\r\n            ...pagination,\r\n            dataSource,\r\n          },\r\n          {\r\n            default: renderTable,\r\n          }\r\n        )\r\n      }\r\n    },\r\n  })\r\n)\r\n\r\nconst ArrayTableColumn = defineComponent({\r\n  name: 'ArrayTableColumn',\r\n  render() {\r\n    return null\r\n  },\r\n})\r\n\r\nexport const ArrayTable = composeExport(ArrayTableInner, {\r\n  Column: ArrayTableColumn,\r\n  Index: ArrayBase.Index,\r\n  SortHandle: ArrayBase.SortHandle,\r\n  Addition: ArrayBase.Addition,\r\n  Remove: ArrayBase.Remove,\r\n  MoveDown: ArrayBase.MoveDown,\r\n  MoveUp: ArrayBase.MoveUp,\r\n  useArray: ArrayBase.useArray,\r\n  useIndex: ArrayBase.useIndex,\r\n  useRecord: ArrayBase.useRecord,\r\n})\r\n\r\nexport default ArrayTable\r\n"]}