{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["form-step/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { PropType } from 'vue'\r\nimport { defineComponent, h } from 'vue'\r\nimport { action, model, observable } from '@formily/reactive'\r\nimport type { VoidField, Form } from '@formily/core'\r\nimport { observer } from '@formily/reactive-vue'\r\nimport {\r\n  useField,\r\n  useFieldSchema,\r\n  RecursionField,\r\n  FragmentComponent,\r\n} from '@formily/vue'\r\nimport type { Schema, SchemaKey } from '@formily/json-schema'\r\nimport { Steps } from 'ant-design-vue'\r\nimport { stylePrefix } from '../__builtins__/configs'\r\n\r\nimport type { StepsProps, StepProps } from 'ant-design-vue/lib/steps'\r\nimport { composeExport } from '../__builtins__/shared'\r\n\r\nconst { Step } = Steps\r\n\r\nexport interface IFormStep {\r\n  connect: (steps: SchemaStep[], field: VoidField) => void\r\n  current: number\r\n  allowNext: boolean\r\n  allowBack: boolean\r\n  setCurrent(key: number): void\r\n  submit: Form['submit']\r\n  next(): void\r\n  back(): void\r\n}\r\n\r\nexport interface IFormStepProps extends StepsProps {\r\n  formStep?: IFormStep\r\n}\r\n\r\ntype SchemaStep = {\r\n  name: SchemaKey\r\n  props: any\r\n  schema: Schema\r\n}\r\n\r\ntype FormStepEnv = {\r\n  form: Form\r\n  field: VoidField\r\n  steps: SchemaStep[]\r\n}\r\n\r\nconst parseSteps = (schema: Schema) => {\r\n  const steps: SchemaStep[] = []\r\n  schema.mapProperties((schema, name) => {\r\n    if (schema['x-component']?.indexOf('StepPane') > -1) {\r\n      steps.push({\r\n        name,\r\n        props: schema['x-component-props'],\r\n        schema,\r\n      })\r\n    }\r\n  })\r\n  return steps\r\n}\r\n\r\nconst createFormStep = (defaultCurrent = 0): IFormStep => {\r\n  const env: FormStepEnv = observable({\r\n    form: null,\r\n    field: null,\r\n    steps: [],\r\n  })\r\n\r\n  const setDisplay = action.bound((target: number) => {\r\n    const currentStep = env.steps[target]\r\n    env.steps.forEach(({ name }) => {\r\n      env.form.query(`${env.field.address}.${name}`).take((field) => {\r\n        if (name === currentStep.name) {\r\n          field.setDisplay('visible')\r\n        } else {\r\n          field.setDisplay('hidden')\r\n        }\r\n      })\r\n    })\r\n  })\r\n\r\n  const next = action.bound(() => {\r\n    if (formStep.allowNext) {\r\n      setDisplay(formStep.current + 1)\r\n      formStep.setCurrent(formStep.current + 1)\r\n    }\r\n  })\r\n\r\n  const back = action.bound(() => {\r\n    if (formStep.allowBack) {\r\n      setDisplay(formStep.current - 1)\r\n      formStep.setCurrent(formStep.current - 1)\r\n    }\r\n  })\r\n\r\n  const formStep: IFormStep = model({\r\n    connect(steps, field) {\r\n      env.steps = steps\r\n      env.form = field?.form\r\n      env.field = field\r\n    },\r\n    current: defaultCurrent,\r\n    setCurrent(key: number) {\r\n      formStep.current = key\r\n    },\r\n    get allowNext() {\r\n      return formStep.current < env.steps.length - 1\r\n    },\r\n    get allowBack() {\r\n      return formStep.current > 0\r\n    },\r\n    async next() {\r\n      try {\r\n        await env.form.validate()\r\n        next()\r\n      } catch {}\r\n    },\r\n    async back() {\r\n      back()\r\n    },\r\n    async submit(onSubmit) {\r\n      return env.form?.submit?.(onSubmit)\r\n    },\r\n  })\r\n  return formStep\r\n}\r\n\r\nconst FormStepInner = observer(\r\n  // eslint-disable-next-line vue/one-component-per-file\r\n  defineComponent({\r\n    name: 'FormStep',\r\n    props: {\r\n      formStep: {\r\n        type: Object as PropType<IFormStep>,\r\n        default() {\r\n          return {\r\n            current: 0,\r\n          }\r\n        },\r\n      },\r\n    },\r\n    setup(props: IFormStepProps, { attrs }) {\r\n      const field = useField<VoidField>().value\r\n      const prefixCls = `${stylePrefix}-form-step`\r\n      const fieldSchemaRef = useFieldSchema()\r\n\r\n      const steps = parseSteps(fieldSchemaRef.value)\r\n\r\n      props.formStep.connect?.(steps, field)\r\n\r\n      return () => {\r\n        const current = props.current || props.formStep?.current || 0\r\n\r\n        const renderSteps = (steps: SchemaStep[], callback) => {\r\n          return steps.map(callback)\r\n        }\r\n\r\n        return h(\r\n          'div',\r\n          {\r\n            class: [prefixCls],\r\n          },\r\n          {\r\n            default: () => [\r\n              h(\r\n                Steps,\r\n                {\r\n                  current,\r\n                  style: [{ marginBottom: '10px' }, attrs.style],\r\n                  attrs,\r\n                },\r\n                {\r\n                  default: () =>\r\n                    renderSteps(steps, ({ props }, key) => {\r\n                      return h(Step, { props, key }, {})\r\n                    }),\r\n                }\r\n              ),\r\n\r\n              renderSteps(steps, ({ name, schema }, key) => {\r\n                if (key !== current) return\r\n                return h(RecursionField, { name, schema, key }, {})\r\n              }),\r\n            ],\r\n          }\r\n        )\r\n      }\r\n    },\r\n  })\r\n)\r\n\r\n// eslint-disable-next-line vue/one-component-per-file\r\nconst StepPane = defineComponent<StepProps>({\r\n  name: 'FormStepPane',\r\n  setup(_props, { slots }) {\r\n    return () => h(FragmentComponent, {}, slots)\r\n  },\r\n})\r\n\r\nexport const FormStep = composeExport(FormStepInner, {\r\n  StepPane,\r\n  createFormStep,\r\n})\r\n\r\nexport default FormStep\r\n"]}